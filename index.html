<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Track å°ç®¡å®¶ v8.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #FFFBF5;
            --card-bg: #FFFFFF;
            --primary-color: #C09F80;
            --secondary-color: #EAD8C0;
            --alert-color: #E57373; 
            --success-color: #81C784;
            --text-main: #5C4033;
            --text-light: #998B82;
            --shadow: 0 4px 12px rgba(92, 64, 51, 0.08);
            --radius: 16px;
            --btn-radius: 50px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-main); padding-bottom: 100px; }

        /* Auth & Overlay */
        #auth-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .auth-box { background: white; padding: 30px; border-radius: 24px; box-shadow: var(--shadow); width: 100%; max-width: 350px; text-align: center; }
        .auth-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: var(--text-main); }
        .auth-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        .auth-btn:active { opacity: 0.8; }
        .btn-login { background: var(--text-main); color: white; }
        .btn-signup { background: transparent; border: 1px solid var(--text-main); color: var(--text-main); }
        .auth-message { margin-top: 15px; font-size: 13px; line-height: 1.4; min-height: 20px; }
        .msg-error { color: var(--alert-color); }
        .msg-success { color: var(--success-color); }

        /* Loading Spinner */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; gap: 10px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--secondary-color); border-top: 4px solid var(--text-main); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; font-weight: bold; color: var(--text-main); }

        /* Lightbox */
        .lightbox-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 11000; display: none; justify-content: center; align-items: center; cursor: zoom-out; animation: fadeIn 0.2s ease; }
        .lightbox-img { max-width: 95%; max-height: 95%; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); object-fit: contain; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Header & Controls */
        header { padding: 12px 16px; position: sticky; top: 0; background: rgba(255, 251, 245, 0.98); backdrop-filter: blur(5px); z-index: 90; border-bottom: 1px solid rgba(192, 159, 128, 0.1); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { font-size: 18px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .settings-btn, .logout-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; }
        .controls-container { display: flex; flex-direction: column; gap: 8px; }
        .search-input { flex: 1; padding: 8px 14px; border-radius: 50px; border: 1px solid var(--secondary-color); background: #FFF; font-size: 14px; outline: none; height: 36px; width: 100%; }
        .filter-controls { display: flex; gap: 6px; align-items: center; overflow-x: auto; padding-bottom: 2px; scrollbar-width: none; }
        .control-select { padding: 6px 10px; border-radius: 20px; border: 1px solid var(--secondary-color); background: #FFF; color: var(--text-main); font-size: 12px; font-weight: 600; height: 30px; }
        .filter-toggle { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-light); margin-left: auto; padding-left: 4px; }
        .filters { display: flex; gap: 8px; padding: 12px 16px 8px 16px; overflow-x: auto; scrollbar-width: none; }
        .filter-btn { background: white; border: 1px solid var(--secondary-color); color: var(--text-light); padding: 6px 14px; border-radius: var(--btn-radius); font-size: 13px; white-space: nowrap; flex-shrink: 0; transition: 0.2s; }
        .filter-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        
        .container { padding: 8px 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
        @media (max-width: 480px) { .container { grid-template-columns: 1fr; } }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--text-light); }
        .empty-icon { font-size: 48px; margin-bottom: 10px; display: block; opacity: 0.5; }

        /* Card Layout - v8.1 Updated */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); border: 2px solid transparent; display: flex; gap: 14px; position: relative; align-items: flex-start; }
        .card.overdue { border-color: var(--alert-color); background: #FFFBFB; }
        .card[data-status="cancel"] { opacity: 0.6; background: #F5F5F5; border-color: #ddd; filter: grayscale(1); }
        .overdue-badge { position: absolute; top: -8px; right: -4px; background: var(--alert-color); color: white; font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: bold; animation: pulse 2s infinite; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Left Column: Tag + Image */
        .card-left-col { display: flex; flex-direction: column; align-items: center; gap: 6px; flex-shrink: 0; margin-right: 2px; }
        
        .card-img-box { width: 80px; height: 80px; border-radius: 12px; overflow: hidden; background: #F5F5F5; display: flex; align-items: center; justify-content: center; cursor: zoom-in; }
        @media (max-width: 480px) { .card-img-box { width: 64px; height: 64px; } }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-no-img { font-size: 24px; color: #CCC; cursor: default; }

        .type-tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: #EEE; color: #666; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Right Content */
        .card-content { flex: 1; display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        
        .user-id-row { display: flex; align-items: center; gap: 6px; width: 100%; }
        .platform-icon { font-size: 16px; flex-shrink: 0; }
        .ig-link { font-weight: 700; font-size: 16px; color: var(--text-main); text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        
        /* New Meta Row: Price + Time */
        .meta-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2px; }
        .price-text { font-weight: bold; color: var(--primary-color); font-size: 14px; font-family: monospace, sans-serif; display: flex; align-items: center; gap: 2px; }
        .time-display { font-size: 11px; color: #999; font-family: monospace; cursor: pointer; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
        .time-display:active { background-color: #F0EAE4; }
        
        .note { font-size: 13px; color: var(--text-light); line-height: 1.4; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 18px; }
        
        .action-row { display: flex; gap: 8px; align-items: center; margin-top: auto; }
        .status-select { flex: 1; padding: 5px 8px; border-radius: 8px; border: 1px solid var(--secondary-color); background: var(--bg-color); font-size: 13px; font-weight: 600; height: 34px; margin-right: 8px; }
        .btn-action { padding: 0 12px; border-radius: 8px; background: var(--secondary-color); color: var(--text-main); border: none; font-size: 12px; font-weight: 600; height: 34px; display: flex; align-items: center; cursor: pointer; margin-left: 4px; }
        .btn-edit { background: #F0EAE4; color: #888; }

        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: var(--text-main); color: white; border: none; box-shadow: 0 4px 15px rgba(92, 64, 51, 0.4); font-size: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; }
        
        /* Modals & Form */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 2000; }
        @media (min-width: 600px) { .modal-overlay { align-items: center; } .modal { border-radius: 24px !important; max-width: 420px; } }
        .modal { background: #FFF; width: 100%; padding: 24px; border-radius: 24px 24px 0 0; animation: slideUp 0.3s ease; overflow-y: auto; max-height: 90vh; }
        @keyframes slideUp { from {transform:translateY(100%);} to {transform:translateY(0);} }
        
        .form-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; display: block; color: var(--text-main); }
        .form-input, .form-textarea { width: 100%; padding: 12px; background: #F8F4F0; border: 1px solid transparent; border-radius: 12px; margin-bottom: 16px; font-size: 16px; }
        .selector-scroll-container { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .selector-option { min-width: 70px; flex: 1; background: #F8F4F0; padding: 10px 4px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; color: #888; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .selector-option.active { background: #FFF; border-color: var(--primary-color); color: var(--text-main); box-shadow: 0 2px 8px rgba(192, 159, 128, 0.2); }
        .selector-option.add-new { border: 2px dashed #DCC0A0; background: transparent; color: var(--primary-color); }
        .opt-icon { font-size: 20px; display: block; margin-bottom: 4px; }
        .opt-text { font-size: 12px; font-weight: 600; display: block; }
        .image-upload-box { border: 2px dashed #DCC0A0; border-radius: 12px; padding: 16px; text-align: center; color: var(--primary-color); margin-bottom: 20px; cursor: pointer; background: #FFFBF5; }
        #previewImage { max-width: 100%; max-height: 150px; border-radius: 8px; display: none; margin-top: 10px; object-fit: contain; }
        .btn-delete-task { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E57373; background: #FFEBEE; color: #E57373; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 12px; display: none; }

        .emoji-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-bottom: 16px; max-height: 150px; overflow-y: auto; padding: 4px; background: #FAFAFA; border-radius: 12px; border: 1px solid #EEE; }
        .emoji-btn { background: #FFF; border: 1px solid #EEE; border-radius: 8px; font-size: 20px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .emoji-btn.selected { background: var(--secondary-color); border-color: var(--primary-color); transform: scale(1.1); }
        .preview-icon-display { font-size: 40px; background: #F8F4F0; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--secondary-color); margin: 0 auto 16px auto; }
        
        .settings-section { margin-bottom: 24px; }
        .settings-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .template-item { margin-bottom: 12px; }
        .template-desc { font-size: 12px; color: #999; margin-bottom: 4px; }
        .template-input { width: 100%; padding: 8px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; font-size: 13px; }
        .custom-item-row { display: flex; justify-content: space-between; padding: 8px 12px; background: #F8F4F0; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }
        .custom-item-btn { background: #E57373; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }

        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; pointer-events: none; z-index: 3000; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <img class="lightbox-img" id="lightboxImg" src="">
    </div>

    <div id="auth-overlay">
        <div class="auth-box">
            <div class="auth-title">ğŸ““ OrderTrack </div>
            <input type="email" id="email" class="form-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" class="form-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½)">
            <button class="auth-btn btn-login" onclick="signIn()" id="btnLogin">ç™»å…¥</button>
            <button class="auth-btn btn-signup" onclick="signUp()" id="btnSignup">è¨»å†Šæ–°å¸³è™Ÿ</button>
            <div id="auth-msg" class="auth-message"></div>
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">è™•ç†ä¸­...</div>
    </div>

    <header>
        <div class="top-row">
            <h1>ğŸ““ OrderTrack <span style="font-size:12px; font-weight:normal; color:#999; margin-left:4px;">v8.1</span></h1>
            <div>
                <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
                <button class="logout-btn" onclick="signOut()" title="ç™»å‡º">ğŸšª</button>
            </div>
        </div>
        
        <div class="controls-container">
            <div class="search-row">
                <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹ ID æˆ–å‚™è¨»..." oninput="renderTasks()">
            </div>
            <div class="filter-controls">
                <select class="control-select" id="timeFilter" onchange="renderTasks()">
                    <option value="all">ğŸ“… å…¨éƒ¨æ™‚é–“</option>
                    <option value="today">ä»Šå¤©</option>
                    <option value="week">æœ¬é€±</option>
                    <option value="month">æœ¬æœˆ</option>
                </select>
                <select class="control-select" id="sortOrder" onchange="renderTasks()">
                    <option value="newest">â–¼ æœ€æ–°</option>
                    <option value="oldest">â–² æœ€èˆŠ</option>
                </select>
                <label class="filter-toggle">
                    <input type="checkbox" class="checkbox" id="showCompleted" onchange="renderTasks()">
                    å·²å®Œæˆ
                </label>
            </div>
        </div>
    </header>

    <div class="filters" id="topFilterContainer"></div>
    <div class="container" id="cardContainer"></div>

    <button class="fab" onclick="openModal()">+</button>
    <div class="toast" id="toast">å·²è¤‡è£½</div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h3 id="modalTitle" style="text-align:center; margin-bottom:16px;">æ–°å¢ä»»å‹™</h3>
            <label class="form-label">å»ºç«‹æ™‚é–“</label>
            <input type="datetime-local" class="form-input" id="inputTime">
            
            <label class="form-label">ä¾†æº (å³æ»‘æ–°å¢)</label>
            <div class="selector-scroll-container" id="platformSelectorContainer"></div>
            
            <label class="form-label">é¡å‹ (å³æ»‘æ–°å¢)</label>
            <div class="selector-scroll-container" id="typeSelectorContainer"></div>
            
            <label class="form-label">ID / å§“å</label>
            <input type="text" class="form-input" id="inputIg" placeholder="ä¾‹å¦‚: jewelry_123">

            <label class="form-label">é‡‘é¡</label>
            <input type="number" class="form-input" id="inputPrice" placeholder="0">
            
            <label class="form-label">ç…§ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
            <div class="image-upload-box" onclick="document.getElementById('fileInput').click()">
                ğŸ“· é»æ“Šä¸Šå‚³ / æ›ç…§ç‰‡
                <img id="previewImage">
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="previewFile()">
            
            <label class="form-label">å‚™è¨»</label>
            <textarea class="form-textarea" id="inputNote" rows="2"></textarea>
            
            <button id="modalSubmitBtn" class="auth-btn btn-login" onclick="saveTask()">å„²å­˜</button>
            <button class="btn-delete-task" id="btnDeleteTask" onclick="deleteTask()">ğŸ—‘ï¸ åˆªé™¤ä»»å‹™</button>
            <button class="auth-btn btn-signup" style="border:none; color:#999;" onclick="closeModal('taskModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal-overlay" id="customItemModal">
        <div class="modal">
            <h3 style="text-align:center;">æ–°å¢è‡ªå®šç¾©</h3>
            <label class="form-label">åç¨±</label>
            <input type="text" class="form-input" id="customName">
            <div class="preview-icon-display" id="emojiPreviewDisplay">ğŸŒ</div>
            <div class="emoji-grid-container" id="emojiGrid"></div>
            <button class="auth-btn btn-login" onclick="saveCustomItem()">ç¢ºèªæ–°å¢</button>
            <button class="auth-btn btn-signup" onclick="closeModal('customItemModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>âš™ï¸ è¨­å®š</h3>
            <div class="settings-section">
                <div class="settings-title">æ–‡æ¡ˆæ¨¡ç‰ˆ</div>
                <div id="templatesList"></div>
            </div>
            <div class="settings-section">
                <div class="settings-title">è‡ªå®šç¾©å¹³å°</div>
                <div id="customPlatformsList"></div>
            </div>
            <div class="settings-section">
                <div class="settings-title">è‡ªå®šç¾©é¡å‹</div>
                <div id="customTypesList"></div>
            </div>
            <button class="auth-btn btn-login" onclick="closeModal('settingsModal')">å®Œæˆ</button>
        </div>
    </div>

    <script>
        // 1. Config
        const SUPABASE_URL = 'https://lixcurjoarfyjdmvdepr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpeGN1cmpvYXJmeWpkbXZkZXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMTU5MDgsImV4cCI6MjA4MDc5MTkwOH0.M_2aLW055JSkwoE3LlsyRv6jy1IfYXq-nZ4H1oDKkNA';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let session = null;
        let tasks = [];
        
        const DEFAULT_PLATFORMS = [
            { id: 'ig', label: 'IG', icon: 'ğŸ“¸', isDefault: true },
            { id: 'fb', label: 'FB', icon: 'ğŸ“˜', isDefault: true },
            { id: 'line', label: 'Line', icon: 'ğŸ’¬', isDefault: true }
        ];
        const DEFAULT_TYPES = [
            { id: 'order', label: 'è¨‚è£½', icon: 'ğŸ›’', isDefault: true },
            { id: 'repair', label: 'ç¶­ä¿®', icon: 'ğŸ”§', isDefault: true },
            { id: 'market', label: 'å¸‚é›†', icon: 'ğŸ‘‹', isDefault: true }
        ];
        const statusMap = {
            making: "ğŸ”¨ è£½ä½œä¸­", waiting_pay: "ğŸ’° å¾…åŒ¯æ¬¾", to_ship: "ğŸ“¦ å¾…å¯„å‡º",
            waiting_package: "ğŸ“« ç­‰åŒ…è£¹", repairing: "ğŸ”§ ç¶­ä¿®ä¸­", pending: "â³ å¾…å›è¦†",
            done: "âœ… å·²å®Œæˆ", cancel: "âŒ å·²å–æ¶ˆ"
        };
        const COMMON_EMOJIS = ["ğŸ’", "ğŸ’", "ğŸ‘‚", "âœ¨", "ğŸ", "ğŸ“¦", "ğŸ“¸", "ğŸ“˜", "ğŸ’¬", "ğŸ“•", "ğŸ›’", "ğŸ›ï¸", "âœ…", "âŒ", "â“"];

        let platforms = [...DEFAULT_PLATFORMS];
        let types = [...DEFAULT_TYPES];
        let templates = {};

        let currentFilter = 'all';
        let selectedPlatformId = 'ig';
        let selectedTypeId = 'order';
        let editingTaskId = null;
        let creatingItemContext = ''; 
        let selectedEmoji = 'ğŸŒ';

        // 2. Auth
        async function initApp() {
            const { data } = await sb.auth.getSession();
            session = data.session;
            if (session) {
                document.getElementById('auth-overlay').style.display = 'none';
                await loadSettings();
                await loadTasks();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
            sb.auth.onAuthStateChange((_event, _session) => {
                session = _session;
                if (session) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    loadSettings();
                    loadTasks();
                } else {
                    document.getElementById('auth-overlay').style.display = 'flex';
                    tasks = [];
                    renderTasks();
                }
            });
        }

        function setAuthMsg(msg, type = 'error') {
            const el = document.getElementById('auth-msg');
            el.innerText = msg;
            el.className = 'auth-message ' + (type === 'success' ? 'msg-success' : 'msg-error');
        }

        async function signIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!email) return setAuthMsg('è«‹è¼¸å…¥ Email');
            if (!password) return setAuthMsg('è«‹è¼¸å…¥å¯†ç¢¼');
            showLoading(true, 'ç™»å…¥ä¸­...');
            setAuthMsg('');
            const { error } = await sb.auth.signInWithPassword({ email, password });
            showLoading(false);
            if (error) setAuthMsg(error.message.includes('Invalid login') ? 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' : error.message);
        }

        async function signUp() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!email) return setAuthMsg('è«‹è¼¸å…¥ Email');
            if (password.length < 6) return setAuthMsg('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 ä½');
            showLoading(true, 'è¨»å†Šä¸­...');
            setAuthMsg('');
            const { error } = await sb.auth.signUp({ email, password });
            showLoading(false);
            if (error) setAuthMsg(error.message);
            else {
                setAuthMsg('è¨»å†ŠæˆåŠŸï¼è‹¥æœªè‡ªå‹•ç™»å…¥ï¼Œè«‹è‡³ä¿¡ç®±é»æ“Šé©—è­‰é€£çµã€‚', 'success');
                document.getElementById('password').value = '';
            }
        }

        async function signOut() { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) await sb.auth.signOut(); }

        // 3. Tasks Logic (with v8.1 features)
        async function loadTasks() {
            showLoading(true, 'è¼‰å…¥ä»»å‹™...');
            const { data, error } = await sb.from('tasks').select('*').order('timestamp', { ascending: false });
            if (!error && data) {
                tasks = data;
                renderTasks();
            }
            showLoading(false);
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                if (file.size > 10 * 1024 * 1024) { 
                    alert('åœ–ç‰‡éå¤§ (è¶…é10MB)ï¼Œè«‹é¸æ“‡è¼ƒå°çš„åœ–ç‰‡');
                    return reject('File too large');
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/webp', 0.7); 
                    };
                };
                reader.onerror = error => reject(error);
            });
        }

        async function saveTask() {
            const ig = document.getElementById('inputIg').value;
            const note = document.getElementById('inputNote').value;
            const price = document.getElementById('inputPrice').value || 0; // v8.1 Price
            const fileInput = document.getElementById('fileInput');
            const timeVal = document.getElementById('inputTime').value;
            
            if (!ig || !timeVal) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
            
            showLoading(true, 'è™•ç†åœ–ç‰‡ä¸­...');
            const timestamp = new Date(timeVal).getTime();
            let img_url = null;

            if (fileInput.files.length > 0) {
                try {
                    const compressedBlob = await compressImage(fileInput.files[0]);
                    const fileName = `${Date.now()}.webp`;
                    const filePath = `${session.user.id}/${fileName}`;
                    showLoading(true, 'ä¸Šå‚³ä¸­...');
                    const { error: uploadError } = await sb.storage.from('jewel-images').upload(filePath, compressedBlob);
                    if (!uploadError) {
                        const { data } = sb.storage.from('jewel-images').getPublicUrl(filePath);
                        img_url = data.publicUrl;
                    }
                } catch (e) { showLoading(false); return; }
            } else if (editingTaskId) {
                const oldTask = tasks.find(t => t.id === editingTaskId);
                img_url = oldTask.img_url;
            }

            const taskData = {
                user_id: session.user.id,
                platform: selectedPlatformId,
                type: selectedTypeId,
                ig, note, timestamp, img_url,
                price: price, // v8.1 Save price
                status: editingTaskId ? tasks.find(t=>t.id===editingTaskId).status : (selectedTypeId==='order'?'waiting_pay':'pending')
            };

            showLoading(true, 'å„²å­˜è³‡æ–™...');
            if (editingTaskId) {
                const { error } = await sb.from('tasks').update(taskData).eq('id', editingTaskId);
                if (!error) await loadTasks();
            } else {
                const { error } = await sb.from('tasks').insert([taskData]);
                if (!error) await loadTasks();
            }
            showLoading(false);
            closeModal('taskModal');
        }

        async function deleteTask() {
            if (!editingTaskId) return;
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
            showLoading(true, 'åˆªé™¤ä¸­...');
            const { error } = await sb.from('tasks').delete().eq('id', editingTaskId);
            if (!error) { await loadTasks(); closeModal('taskModal'); } else { alert('åˆªé™¤å¤±æ•—'); }
            showLoading(false);
        }

        async function updateStatus(id, newStatus) {
            const tIndex = tasks.findIndex(x => x.id === id);
            if(tIndex > -1) { tasks[tIndex].status = newStatus; renderTasks(); }
            await sb.from('tasks').update({ status: newStatus }).eq('id', id);
        }

        // 4. Settings Logic
        async function loadSettings() {
            const { data, error } = await sb.from('user_settings').select('*').single();
            if (data && !error) {
                if (data.config) {
                    platforms = data.config.platforms || [...DEFAULT_PLATFORMS];
                    types = data.config.types || [...DEFAULT_TYPES];
                }
                if (data.templates) { templates = data.templates; }
            } else if (!data) {
                templates = {
                    making: "è¦ªæ„›çš„ï¼Œæ‚¨çš„é£¾å“æ­£åœ¨è£½ä½œä¸­å›‰ï¼Œè«‹è€å¿ƒç­‰å€™ â¤ï¸",
                    waiting_pay: "åŒ¯æ¬¾å¸³è™Ÿï¼š(822) 1234-5678ï¼Œé‡‘é¡ $___ï¼ŒåŒ¯æ¬¾å¾Œè«‹é€šçŸ¥æˆ‘å–”ï¼",
                    to_ship: "æ‚¨çš„å•†å“å·²åŒ…è£å®Œæˆï¼Œå°‡æ–¼æ˜å¤©ç‚ºæ‚¨å¯„å‡ºï¼ğŸ“¦",
                    done: "è¦ªæ„›çš„ï¼Œæ‚¨çš„é£¾å“å·²ç¶“å®Œæˆå›‰ï¼é€™è£¡æ˜¯æˆå“ç…§ç‰‡ âœ¨",
                    cancel: "å¥½çš„ï¼Œå·²ç‚ºæ‚¨å–æ¶ˆè¨‚å–®ã€‚"
                };
                await saveSettingsDB();
            }
            renderTopFilters();
        }

        async function saveSettingsDB() {
            const config = { platforms, types };
            await sb.from('user_settings').upsert({ user_id: session.user.id, config, templates });
        }

        // 5. Render Logic
        function renderTasks() {
            const container = document.getElementById('cardContainer');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const showCompleted = document.getElementById('showCompleted').checked;
            const sortOrder = document.getElementById('sortOrder').value;
            const timeFilter = document.getElementById('timeFilter').value;

            container.innerHTML = '';

            let filtered = tasks.filter(t => {
                if (currentFilter !== 'all' && t.type !== currentFilter) return false;
                if (!t.ig.toLowerCase().includes(searchVal) && !t.note.toLowerCase().includes(searchVal)) return false;
                if (!showCompleted && (t.status === 'done' || t.status === 'cancel')) return false;
                
                if (timeFilter !== 'all') {
                    const tDate = new Date(t.timestamp);
                    const today = new Date();
                    const diffTime = today - tDate;
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);
                    if (timeFilter === 'today') {
                        if (tDate.getDate() !== today.getDate() || tDate.getMonth() !== today.getMonth()) return false;
                    } else if (timeFilter === 'week') {
                        if (diffDays > 7) return false;
                    } else if (timeFilter === 'month') {
                        if (tDate.getMonth() !== today.getMonth()) return false;
                    }
                }
                return true;
            });

            filtered.sort((a, b) => {
                if (sortOrder === 'newest') return b.timestamp - a.timestamp;
                return a.timestamp - b.timestamp;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><span class="empty-icon">ğŸ“­</span><br>ç›®å‰æ²’æœ‰ä»»å‹™<br>é»æ“Šå³ä¸‹è§’ + æ–°å¢</div>`;
                return;
            }

            filtered.forEach(t => {
                const isOverdue = (t.status !== 'done' && t.status !== 'cancel' && (Date.now() - t.timestamp > 3*24*60*60*1000));
                const platformObj = platforms.find(p => p.id === t.platform) || { icon: 'â“', label: 'æœªçŸ¥' };
                const typeObj = types.find(x => x.id === t.type) || { icon: 'â“', label: 'æœªçŸ¥' };
                const timeStr = formatTime(t.timestamp);
                
                const imgHtml = t.img_url 
                    ? `<img src="${t.img_url}" class="card-img" onclick="openLightbox('${t.img_url}')">` 
                    : `<div class="card-no-img">ğŸ“·</div>`;
                
                // v8.1 Price Display Logic
                const priceHtml = (t.price && t.price > 0) ? `<span class="price-text">$${t.price}</span>` : `<span></span>`;

                let opts = '';
                for(let k in statusMap) opts += `<option value="${k}" ${t.status===k?'selected':''}>${statusMap[k]}</option>`;

                const div = document.createElement('div');
                div.className = `card ${isOverdue?'overdue':''} ${t.status==='cancel'?'cancel':''}`;
                
                div.innerHTML = `
                    ${isOverdue ? '<div class="overdue-badge">âš ï¸ é€¾æœŸ</div>' : ''}
                    
                    <div class="card-left-col">
                        <span class="type-tag">${typeObj.label}</span>
                        <div class="card-img-box">${imgHtml}</div>
                    </div>

                    <div class="card-content">
                        <div class="user-id-row">
                            <span class="platform-icon">${platformObj.icon}</span>
                            <span class="ig-link" onclick="copyText('${t.ig}')">${t.ig}</span>
                        </div>
                        
                        <div class="meta-row">
                            ${priceHtml}
                            <div class="time-display" onclick="openModal(${t.id})">ğŸ•’ ${timeStr}</div>
                        </div>

                        <div class="note">${t.note}</div>
                        
                        <div class="action-row">
                            <select class="status-select" onchange="updateStatus(${t.id}, this.value)">${opts}</select>
                            <button class="btn-action btn-edit" onclick="openModal(${t.id})">âœ</button>
                            <button class="btn-action" onclick="copyTemplate('${t.status}')">ğŸ“‹</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- Helpers ---
        function copyText(txt) { navigator.clipboard.writeText(txt); showToast('å·²è¤‡è£½'); }
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        function showLoading(show, text='è™•ç†ä¸­...') { 
            const el = document.getElementById('loading');
            if(show) { el.querySelector('.loading-text').innerText=text; el.style.display='flex'; } 
            else el.style.display='none'; 
        }
        function openLightbox(url) { document.getElementById('lightboxImg').src = url; document.getElementById('lightbox').style.display = 'flex'; }
        function closeLightbox() { document.getElementById('lightbox').style.display = 'none'; }

        function openModal(editId = null) {
            editingTaskId = editId;
            const modal = document.getElementById('taskModal');
            document.getElementById('fileInput').value = '';
            const btnDelete = document.getElementById('btnDeleteTask');

            if (editId) {
                const t = tasks.find(x => x.id === editId);
                document.getElementById('modalTitle').innerText = "ç·¨è¼¯ä»»å‹™";
                document.getElementById('modalSubmitBtn').innerText = "ä¿å­˜";
                document.getElementById('inputIg').value = t.ig;
                document.getElementById('inputNote').value = t.note;
                // v8.1 Load Price
                document.getElementById('inputPrice').value = t.price || ''; 
                
                const localDate = new Date(t.timestamp - (new Date().getTimezoneOffset()*60000));
                document.getElementById('inputTime').value = localDate.toISOString().slice(0,16);
                selectedPlatformId = t.platform;
                selectedTypeId = t.type;
                const p = document.getElementById('previewImage');
                if(t.img_url) { p.src=t.img_url; p.style.display='block'; } else { p.style.display='none'; }
                btnDelete.style.display = 'block';
            } else {
                document.getElementById('modalTitle').innerText = "æ–°å¢ä»»å‹™";
                document.getElementById('modalSubmitBtn').innerText = "å»ºç«‹";
                document.getElementById('inputIg').value = '';
                document.getElementById('inputNote').value = '';
                // v8.1 Reset Price
                document.getElementById('inputPrice').value = ''; 
                
                const now = new Date(Date.now() - (new Date().getTimezoneOffset()*60000));
                document.getElementById('inputTime').value = now.toISOString().slice(0,16);
                document.getElementById('previewImage').style.display='none';
                selectedPlatformId = platforms[0].id;
                selectedTypeId = types[0].id;
                btnDelete.style.display = 'none';
            }
            renderSelectors('platformSelectorContainer', platforms, selectedPlatformId, 'setPlatform', 'platform');
            renderSelectors('typeSelectorContainer', types, selectedTypeId, 'setType', 'type');
            modal.style.display = 'flex';
        }

        // ... (Selectors, Custom Item, Settings logic same as v8.0) ...
        function renderSelectors(cid, items, activeId, fnName, context) {
            const c = document.getElementById(cid); let h='';
            items.forEach(i => h += `<div class="selector-option ${i.id===activeId?'active':''}" onclick="${fnName}('${i.id}')"><span class="opt-icon">${i.icon}</span><span class="opt-text">${i.label}</span></div>`);
            h += `<div class="selector-option add-new" onclick="openCustomItemModal('${context}')"><span class="opt-icon">â•</span><span class="opt-text">æ–°å¢</span></div>`;
            c.innerHTML = h;
        }
        function setPlatform(id) { selectedPlatformId=id; renderSelectors('platformSelectorContainer', platforms, id, 'setPlatform', 'platform'); }
        function setType(id) { selectedTypeId=id; renderSelectors('typeSelectorContainer', types, id, 'setType', 'type'); }
        function openCustomItemModal(ctx) { creatingItemContext=ctx; document.getElementById('customName').value=''; updateEmojiPreview('ğŸŒ'); renderEmojiGrid(); document.getElementById('customItemModal').style.display='flex'; }
        function renderEmojiGrid() { let h=''; COMMON_EMOJIS.forEach(e=>h+=`<div class="emoji-btn" onclick="updateEmojiPreview('${e}')">${e}</div>`); document.getElementById('emojiGrid').innerHTML=h; }
        function updateEmojiPreview(e) { selectedEmoji=e; document.getElementById('emojiPreviewDisplay').innerText=e; }
        async function saveCustomItem() {
            const label=document.getElementById('customName').value; if(!label) return;
            const newId='custom_'+Date.now(); const item={id:newId,label,icon:selectedEmoji,isDefault:false};
            showLoading(true);
            if(creatingItemContext==='platform') { platforms.push(item); await saveSettingsDB(); setPlatform(newId); }
            else { types.push(item); await saveSettingsDB(); setType(newId); renderTopFilters(); }
            showLoading(false); closeModal('customItemModal');
        }
        function openSettings() {
            const list=document.getElementById('templatesList'); list.innerHTML='';
            ['waiting_pay','to_ship','making','repairing','done','cancel'].forEach(k => {
                list.innerHTML += `<div class="template-item"><div class="template-desc">${statusMap[k]}</div><input class="template-input" value="${templates[k]||''}" onchange="saveTemplate('${k}',this.value)"></div>`;
            });
            renderCustomList('customPlatformsList', platforms, 'deletePlatform');
            renderCustomList('customTypesList', types, 'deleteType');
            document.getElementById('settingsModal').style.display='flex';
        }
        function renderCustomList(cid, items, fnName) {
            const c=document.getElementById(cid); let h='';
            items.filter(i=>!i.isDefault).forEach(i => h+=`<div class="custom-item-row"><span>${i.icon} ${i.label}</span><button class="custom-item-btn" onclick="${fnName}('${i.id}')">åˆªé™¤</button></div>`);
            c.innerHTML=h||'<div style="color:#ccc;font-size:12px;padding:8px;">ç„¡è‡ªå®šç¾©é …ç›®</div>';
        }
        async function deletePlatform(id) { if(confirm('åˆªé™¤?')) { platforms=platforms.filter(p=>p.id!==id); await saveSettingsDB(); openSettings(); renderTasks(); } }
        async function deleteType(id) { if(confirm('åˆªé™¤?')) { types=types.filter(t=>t.id!==id); await saveSettingsDB(); renderTopFilters(); openSettings(); renderTasks(); } }
        async function saveTemplate(k,v) { templates[k]=v; await saveSettingsDB(); }
        function renderTopFilters() {
            const c=document.getElementById('topFilterContainer');
            let h=`<button class="filter-btn ${currentFilter==='all'?'active':''}" onclick="setFilter('all')">å…¨éƒ¨</button>`;
            types.forEach(t=>h+=`<button class="filter-btn ${currentFilter===t.id?'active':''}" onclick="setFilter('${t.id}')">${t.label}</button>`);
            c.innerHTML=h;
        }
        function setFilter(t) { currentFilter=t; renderTopFilters(); renderTasks(); }
        function formatTime(ts) {
            const d=new Date(ts);
            return `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
        }
        function copyTemplate(s) { copyText(templates[s]||'ç„¡æ–‡æ¡ˆ'); }
        function previewFile() {
            const p=document.getElementById('previewImage'); const f=document.getElementById('fileInput').files[0];
            const r=new FileReader(); r.onload=e=>{ p.src=e.target.result; p.style.display='block'; };
            if(f) r.readAsDataURL(f);
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        document.querySelectorAll('.modal-overlay').forEach(e => e.addEventListener('click', ev => { if(ev.target===e) e.style.display='none'; }));

        initApp();
    </script>
</body>
</html>
